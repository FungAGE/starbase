!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).ClusterMap={})}(this,function(t){"use strict";function e(t){if(t.defaultPrevented)return;let e=d3.select(t.target),l=prompt("Enter new value:",e.text());l&&e.text(l)}function l(t,e=.6){let l=d3.color(t).rgb();return d3.rgb(255*(1-e)+e*l.r,255*(1-e)+e*l.g,255*(1-e)+e*l.b)}function a(t,e){return Math.max(Math.min(d3.bisectLeft(t,e),t.length-1),0)}function n(t,e,l){let a=u[t].domain(),n=u[t].range();n[a.indexOf(e)]=l,u[t].range(n)}let r=Object.assign({},{plot:{transitionDuration:250,scaleFactor:15,scaleGenes:!0,fontFamily:'system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Ubuntu, "Helvetica Neue", Oxygen, Cantarell, sans-serif'},legend:{entryHeight:18,fontSize:14,onClickCircle:null,onClickText:null,show:!0,marginLeft:20},colourBar:{fontSize:10,height:12,show:!0,width:150,marginTop:20},scaleBar:{colour:"black",fontSize:10,height:12,basePair:2500,show:!0,stroke:1,marginTop:20},link:{show:!0,asLine:!1,straight:!1,threshold:0,strokeWidth:.5,groupColour:!1,bestOnly:!1,label:{show:!1,fontSize:10,background:!0,position:.5}},cluster:{nameFontSize:12,lociFontSize:10,hideLocusCoordinates:!1,spacing:40,alignLabels:!0},locus:{trackBar:{colour:"#111",stroke:1},spacing:50},gene:{shape:{bodyHeight:12,tipHeight:5,tipLength:12,onClick:null,stroke:"black",strokeWidth:1},label:{anchor:"start",fontSize:10,rotation:25,position:"top",spacing:2,show:!1,start:.5,name:"uid"}}}),s={isDragging:!1};function o(t,e){return d3.select(`#${e}_${t}`)}let i={gene:t=>o(t,"gene"),locus:t=>o(t,"locus"),cluster:t=>o(t,"cluster"),geneData:t=>i.gene(t).datum(),locusData:t=>i.locus(t).datum(),clusterData:t=>i.cluster(t).datum(),matrix:t=>t.node().transform.baseVal[0].matrix},c={legendTransform(t){let[e,l]=p.extent(t.clusters);return`translate(${l+r.legend.marginLeft}, 0)`},bottomY(){let t=u.y.range(),e=r.gene.shape.bodyHeight+2*r.gene.shape.tipHeight;return t[t.length-1]+e},colourBarTransform:()=>`translate(${r.plot.scaleGenes?u.x(r.scaleBar.basePair)+20:0}, ${c.bottomY()+r.colourBar.marginTop})`,scaleBarTransform:()=>`translate(0, ${c.bottomY()+r.scaleBar.marginTop})`,updateConfig:function(t){!function t(e,l){var a;for(let[n,r]of Object.entries(l))e.hasOwnProperty(n)&&((a=r)&&a.constructor===Object?t(e[n],r):e[n]=r)}(r,t)},update:null,data:null},u={x:d3.scaleLinear().domain([1,1001]).range([0,r.plot.scaleFactor]),y:d3.scaleOrdinal(),group:d3.scaleOrdinal().unknown(null),colour:d3.scaleOrdinal().unknown("#bbb"),name:d3.scaleOrdinal().unknown("None"),score:d3.scaleSequential(d3.interpolateGreys).domain([0,1]),offset:d3.scaleOrdinal(),locus:d3.scaleOrdinal()},d={getId:t=>`gene_${t.uid}`,fill(t){if(t.colour)return t.colour;if(!u.group)return"#bbb";let e=u.group(t.uid);return u.colour(e)},points(t){let e=[],l=u.x(t.start),a=u.x(t.end),n=a-l,s=2*r.gene.shape.tipHeight+r.gene.shape.bodyHeight,o=s/2,i=r.gene.shape.tipHeight+r.gene.shape.bodyHeight;if(1===t.strand){let c=a-r.gene.shape.tipLength;e=[l,r.gene.shape.tipHeight,c,r.gene.shape.tipHeight,c,0,a,o,c,s,c,i,l,i],n<r.gene.shape.tipLength&&[2,4,8,10].forEach(t=>e[t]=l)}else{let d=l+r.gene.shape.tipLength;e=[a,r.gene.shape.tipHeight,d,r.gene.shape.tipHeight,d,0,l,o,d,s,d,i,a,i],n<r.gene.shape.tipLength&&[2,4,8,10].forEach(t=>e[t]=a)}return e.join(" ")},labelTransform(t){let e,l;return`translate(${u.x(t.start)+u.x(t.end-t.start)*r.gene.label.start}, ${e="middle"===r.gene.label.position?r.gene.shape.tipHeight+r.gene.shape.bodyHeight/2:"bottom"===r.gene.label.position?2*r.gene.shape.tipHeight+r.gene.shape.bodyHeight+r.gene.label.spacing:-r.gene.label.spacing}) rotate(${["start","middle"].includes(r.gene.label.anchor)?-r.gene.label.rotation:r.gene.label.rotation})`},labelDy(){switch(r.gene.label.position){case"top":return"-0.4em";case"middle":return"0.4em";case"bottom":return"0.8em"}},tooltipHTML(t){let e=d3.create("div").attr("class","tooltip-contents").style("display","flex").style("flex-direction","column");e.append("text").text("Edit label");let l=e.append("input").attr("type","input").attr("value",t.label||t.uid);e.append("text").text("Gene qualifiers");let a=e.append("select").attr("multiple",!0);a.selectAll("option").data(Object.keys(t.names)).join("option").text(e=>`${t.names[e]} [${e}]`).attr("value",e=>t.names[e]);let n=e.append("div").style("margin-top","2px").append("text"),r=u.group(t.uid);return n.append("tspan").text("Similarity group: "),n.append("tspan").text(u.name(r)).style("color",u.colour(r)).style("font-weight","bold"),e.append("label").append("text").text("Choose gene colour: ").append("input").attr("type","color").attr("default",u.colour(r)).on("change",e=>{t.colour=e.target.value,c.update()}),e.append("button").text("Anchor map on gene").on("click",e=>d.anchor(e,t,!0)),l.on("input",e=>{t.label=e.target.value,a.attr("value",null),c.update({})}),a.on("change",e=>{t.label=e.target.value,l.attr("value",e.target.value),c.update({})}),e},contextMenu(t,e){t.preventDefault();let l=d3.select("div.tooltip");l.html(""),l.append(()=>d.tooltipHTML(e).node());let a=t.target.getBoundingClientRect(),n=l.node().getBoundingClientRect(),r=a.width/2-n.width/2,s=1.2*a.height;l.style("left",a.x+r+"px").style("top",a.y+s+"px"),l.transition().duration(100).style("opacity",1).style("pointer-events","all"),l.transition().delay(1e3).style("opacity",0).style("pointer-events","none")},labelText:t=>t.label||t.uid,polygonClass(t){let e=u.group(t.uid);return null!==e?`genePolygon group-${e}`:"genePolygon"},update:t=>(t.selectAll("polygon").attr("class",d.polygonClass).attr("points",d.points).attr("fill",d.fill).style("stroke",r.gene.shape.stroke).style("stroke-width",r.gene.shape.strokeWidth),t.selectAll("text.geneLabel").text(d.labelText).attr("dy",d.labelDy).attr("display",r.gene.label.show?"inherit":"none").attr("transform",d.labelTransform).attr("font-size",r.gene.label.fontSize).attr("text-anchor",r.gene.label.anchor),t),anchor(t,e,l=!1){let a=u.offset.domain(),n=u.offset.range(),r=new Map;if(u.group.domain().filter(t=>{let l=u.group(t),a=u.group(e.uid);return null!==l&&l===a}).forEach(t=>{let a=i.geneData(t);if(l&&a.strand!==e.strand){let n=i.locusData(a._locus);f.flip(n),f.updateScaling(n)}r.has(a._cluster)?r.get(a._cluster).push(t):r.set(a._cluster,[t])}),0===r.length)return;let s=t=>u.x(t.start+(t.end-t.start)/2)+u.locus(t._locus)+u.offset(t._cluster),o=s(e),d=t=>{if(t.includes(e.uid))return 0;let l=t.map(t=>{var e;return e=t,o-s(i.geneData(e))});return l[d3.minIndex(l,t=>Math.abs(t))]};for(let[p,g]of r.entries())n[a.findIndex(t=>t===p)]+=d(g);u.offset.range(n),c.update()}},p={getId:t=>`cluster_${t.uid}`,transform:t=>`translate(${u.offset(t.uid)}, ${u.y(t.uid)})`,locusText:t=>t.loci.map(t=>{let e,l;if(t._bio_start){let a=t._start-t.start,n=t.end-t._end;t._flipped&&([a,n]=[n,a]),e=t._bio_start+a+1,l=t._bio_end-n}else e=t._start+1,l=t._end;t._flipped&&([e,l]=[l,e]);let s=t._flipped?" (reversed)":"";return r.cluster.hideLocusCoordinates||null==t._start||null==t._end?`${t.name}${s}`:`${t.name}${s}:${e.toFixed(0)}-${l.toFixed(0)}`}).join(", "),extentOne(t,e){let l,a;for(let n of(e=e||[],t.loci)){if(e.includes(n.uid))continue;let r=u.offset(t.uid)+u.locus(n.uid),s=u.x(n._start)+r,o=u.x(n._end)+r;(!l||l&&s<l)&&(l=s),(!a||a&&o>a)&&(a=o)}return[l,a]},extent(t){let e,l;for(let a of(t=t||[],u.offset.domain())){let n=i.clusterData(a),[r,s]=p.extentOne(n,t);(!e||e&&r<e)&&(e=r),(!l||l&&s>l)&&(l=s)}return[e,l]},adjacent(t,e){let l=i.cluster(t).datum(),a=i.cluster(e).datum();return 1===Math.abs(l.slot-a.slot)},getRange(t){let e,l,a,n=[],s=1;for(let[o,i]of t.loci.entries())o>0&&(s=n[n.length-1]+l-e+r.locus.spacing),a=u.locus(i.uid)||0,e=u.x(i._start||i.start),l=u.x(i._end||i.end),n.push(s-e+a);return n},getLocusScaleValues(t){let e=[],l=[];return t.forEach(t=>{let a=t.loci.map(t=>t.uid),n=p.getRange(t);e.push(...a),l.push(...n)}),[e,l]},alignLabels(t){let[e,l]=p.extent();return t.attr("transform",t=>`translate(${e-u.offset(t.uid)-10}, 0)`)},update:t=>(t.selectAll("g.locus").each(f.updateScaling),t.attr("transform",p.transform),r.cluster.alignLabels?t.selectAll(".clusterInfo").call(p.alignLabels):t.selectAll(".clusterInfo").attr("transform",t=>{let[e,l]=p.extentOne(t);return`translate(${e-10-u.offset(t.uid)}, 0)`}),t.selectAll("text.locusText").text(p.locusText).style("font-size",`${r.cluster.lociFontSize}px`),t.selectAll("text.clusterText").style("font-size",`${r.cluster.nameFontSize}px`),t),drag(t){let e,l,a,n;return t.each((t,e)=>{t.slot=e}),d3.drag().container(function(){return this.parentNode.parentNode}).on("start",(t,r)=>{s.isDragging=!0,e=r.slot;let o=i.cluster(r.uid);o.classed("active",!0).attr("cursor","grabbing"),l=i.matrix(o).f-t.y,n=(a=u.y.range())[a.length-1]}).on("drag",(a,r)=>{let s=i.cluster(r.uid);s.raise();let o=Math.min(n,Math.max(0,l+a.y));s.attr("transform",t=>`translate(${u.offset(t.uid)}, ${o})`);let c=Math.round(o/(n/u.y.domain().length));d3.selectAll("g.geneLinkG").call(g.update),c!==r.slot&&t.each(function(t){if(t.uid!==r.uid&&t.slot===c){t.slot=e,r.slot=e=c;let l=u.y.domain()[t.slot],a=t=>`translate(${u.offset(t.uid)}, ${u.y(l)})`;i.cluster(t.uid).transition().attr("transform",a)}})}).on("end",()=>{s.isDragging=!1;let e,l=(e=[],t.each(t=>{e.push(t)}),(e=e.sort((t,e)=>t.slot>e.slot?1:-1)).map(t=>t.uid));u.y.domain(l),c.update()})(t)}},g={getId:t=>`link-${t.uid}`,opacity(t){let e=i.gene(t.query.uid).attr("display"),l=i.gene(t.target.uid).attr("display"),a=["none",null];return!r.link.show||a.includes(e)||a.includes(l)?0:1},fill:t=>r.link.asLine?"none":r.link.groupColour?l(u.colour(u.group(t.query.uid))):u.score(t.identity),stroke(t){if(r.link.groupColour){let e=u.colour(u.group(t.query.uid));return r.link.asLine?l(e):e}return r.link.asLine?u.score(t.identity):"black"},update(t,e){if(!r.link.show)return t.attr("opacity",0);let l={};return t.each(function(t){let a=g.getAnchors(t,e);if(!a||t.identity<r.link.threshold)return void(l[t.uid]={d:null,anchors:null,opacity:0,x:null,y:null});let[n,s,o,i,c,u]=a,d=n+(s-n)/2,p=d+(i+(c-i)/2-d)*r.link.label.position,f=o+Math.abs(u-o)*r.link.label.position;l[t.uid]={d:`M${n},${o} L${s},${o} L${c},${u} L${i},${u} L${n},${o}`,anchors:a,opacity:1,x:p,y:f}}),t.attr("opacity",1),t.selectAll("path").attr("d",t=>g.path(l[t.uid].anchors)).style("fill",g.fill).style("stroke",g.stroke).style("stroke-width",`${r.link.strokeWidth}px`),t.selectAll("text").attr("opacity",t=>r.link.label.show?l[t.uid].opacity:0).attr("filter",()=>r.link.label.background?"url(#filter_solid)":null).style("font-size",()=>`${r.link.label.fontSize}px`).attr("x",t=>l[t.uid].x).attr("y",t=>l[t.uid].y),t},sankey([t,e,l,a,n,r]){let s=l+Math.abs(r-l)/2,o=d3.path();return o.moveTo(e,l),o.bezierCurveTo(e,s,n,s,n,r),o.lineTo(a,r),o.bezierCurveTo(a,s,t,s,t,l),o.lineTo(e,l),o.toString()},straight:([t,e,l,a,n,r])=>`M${t},${l} L${e},${l} L${n},${r} L${a},${r} L${t},${l}`,line([t,e,l,a,n,s]){let o=t+(e-t)/2,i=a+(n-a)/2;return r.link.straight?`M${o},${l} L${i},${s}`:d3.linkVertical()({source:[o,l],target:[i,s]})},path:t=>t?r.link.asLine?g.line(t):r.link.straight?g.straight(t):g.sankey(t):"",filter(t){if(t=t.filter(t=>{let e=null!==u.group(t.query.uid),l=null!==u.group(t.target.uid);return e&&l}),!r.link.bestOnly)return t;let e=(t,e)=>t.size===e.size&&[...t].every(t=>e.has(t));class l extends Map{has(...t){if(0===this.size)return!1;for(let l of this.keys())if(e(t[0],l))return!0;return!1}get(...t){for(let[l,a]of this)if(e(t[0],l))return a}set(...t){let e=this.get(t[0])||t[0];return super.set(e,t[1])}reduce(){let t=[];for(let e of this.values())t=t.concat(e);return t}}let a=new l;for(let n of(t.sort((t,e)=>t.identity<e.identity?1:-1),t)){let s=i.geneData(n.query.uid)._cluster,o=i.geneData(n.target.uid)._cluster,c=new Set([s,o]);a.has(c)?a.get(c).some(t=>{let e=new Set([t.query.uid,t.target.uid]);return(e.has(n.query.uid)||e.has(n.target.uid))&&n.identity<t.identity})||a.get(c).push(n):a.set(c,[n])}return a.reduce().filter(t=>t.identity>r.link.threshold)},getAnchors(t,e){e=e||!1;let l=i.geneData(t.query.uid),a=i.geneData(t.target.uid);if(!p.adjacent(l._cluster,a._cluster))return null;let n=r.gene.shape.tipHeight+r.gene.shape.bodyHeight/2,s=t=>{if(e)return u.offset(t._cluster)+u.locus(t._locus);let l=i.locus(t._locus),a=i.matrix(l);return u.offset(t._cluster)+a.e},o=s(l),c=s(a),d=(t,l)=>{let a=i.cluster(t._cluster),r=i.matrix(a),s=u.x(t.start)+l,o=u.x(t.end)+l;return[-1===t.strand?o:s,-1===t.strand?s:o,e?u.y(t._cluster)+n:r.f+n]},[g,f,h]=d(l,o),[y,m,x]=d(a,c);return h>x?[y,m,x,g,f,h]:[g,f,h,y,m,x]},getGroups(t,e){let l=t.map(t=>[t.query.uid,t.target.uid]).map((t,e,l)=>l.slice(e).reduce((e,l)=>t.some(t=>l.includes(t))?[...new Set([...e,...l])]:e,[])).map((t,e)=>({label:`Group ${e}`,genes:t,hidden:!1,colour:null})).reduce((t,e)=>{let l=!1;return t=t.map(t=>(t.genes.some(t=>e.genes.includes(t))&&(l=!0,t.genes=[...new Set([...t.genes,...e.genes])]),t)),l||t.push({...e,uid:t.length}),t},e||[]);return e||l.forEach((t,e)=>t.label=`Group ${e}`),l},getGroupDomainAndRange(t){let e={domain:[],range:[]};return t.forEach(t=>{if(!t.hidden)for(let l of t.genes)e.domain.push(l),e.range.push(t.uid)}),e},updateGroups(t){let{domain:e,range:l}=g.getGroupDomainAndRange(t),a=t.map(t=>t.uid);u.group.domain(e).range(l),u.name.domain(a).range(t.map(t=>t.label));let n=d3.quantize(d3.interpolateRainbow,t.length+1);t.forEach((t,e)=>{t.colour?n[e]=t.colour:t.colour=n[e]}),u.colour.domain(a).range(n)},hide(t,e){t.preventDefault(),e.hidden=!0,c.update()},rename(t,e){if(t.defaultPrevented)return;let l=d3.select(t.target),a=prompt("Enter new value:",l.text());a&&(e.label=a,l.text(a),c.update())}},f={getId:t=>`locus_${t.uid}`,realLength:t=>u.x(t._end-t._start),updateTrackBar(t){let e=r.gene.shape.tipHeight+r.gene.shape.bodyHeight/2;return t.select("line.trackBar").attr("x1",t=>u.x(t._start)).attr("x2",t=>u.x(t._end)).attr("y1",e).attr("y2",e).style("stroke",r.locus.trackBar.colour).style("stroke-width",r.locus.trackBar.stroke),t},updateHoverBox(t){let e=2*r.gene.shape.tipHeight+r.gene.shape.bodyHeight;return t.selectAll("rect.hover, rect.leftHandle, rect.rightHandle").attr("y",-10).attr("height",e+20),t.select("rect.hover").attr("x",t=>u.x(t._start)).attr("width",f.realLength),t.select("rect.leftHandle").attr("x",t=>u.x(t._start)-8),t.select("rect.rightHandle").attr("x",t=>u.x(t._end)),t},updateScaling(t){t.genes.forEach((t,e,l)=>{let a=r.plot.scaleGenes?t._end-t._start:1e3;t.start=r.plot.scaleGenes?t._start:e>0?l[e-1].end:0,t.end=t.start+a,t.strand=t._strand});let e=t._start,l=t.genes.length-1;t._start=t._trimLeft?t._trimLeft.start:0,t._end=t._trimRight?t._trimRight.end:r.plot.scaleGenes?t.end:t.genes[l].end,n("locus",t.uid,u.locus(t.uid)+u.x(e-t._start))},update:t=>t.attr("transform",t=>`translate(${u.locus(t.uid)}, 0)`).call(f.updateTrackBar).call(f.updateHoverBox),dragResize(t){let e,l,n=(t,n,s)=>{let o=n.genes.filter(t=>t.end<=n._end).sort((t,e)=>t.start>e.start?1:-1),c=[n.start,...o.map(t=>t.start)],d=c.map(t=>u.x(t)),p=a(d,t.x);l=d[p],n._start=c[p],n._trimLeft=n._start===c[0]?null:o[p-1],s.attr("x",l-8);let h=i.locus(n.uid);if(h.select("rect.hover").attr("x",l).attr("width",f.realLength),h.selectAll("g.gene").attr("display",t=>t.start>=n._start&&t.end<=n._end+1?"inline":"none"),h.call(f.updateTrackBar),d3.selectAll("path.geneLink").attr("opacity",g.opacity),r.cluster.alignLabels){let y=Math.min(l+(u.offset(n._cluster)+u.locus(n.uid)),e)-10;d3.selectAll("g.clusterInfo").attr("transform",t=>`translate(${y-u.offset(t.uid)}, 0)`)}else d3.select(`#cinfo_${n._cluster}`).attr("transform",`translate(${u.locus(n.uid)+u.x(n._start)-10}, 0)`)},o=(t,e,l)=>{let n=e.genes.filter(t=>t.start>=e._start).sort((t,e)=>t.start>e.start?1:-1),s=[...n.map(t=>t.end),r.plot.scaleGenes?e.end:e._end],o=a(s.map(t=>u.x(t)),t.x);e._trimRight=n[o]?n[o]:null,e._end=s[o],l.attr("x",u.x(e._end));let d=i.locus(e.uid);d.select("rect.hover").attr("width",f.realLength),d.selectAll("g.gene").attr("display",t=>t.start>=e._start&&t.end<=e._end+1?"inline":"none"),d.call(f.updateTrackBar),d3.selectAll("path.geneLink").attr("opacity",g.opacity),d3.select("g.legend").attr("transform",c.legendTransform)};return d3.drag().on("start",(t,l)=>{[e,t]=p.extent([l.uid]),s.isDragging=!0,u.x(l._start)}).on("drag",function(t,e){let l=d3.select(this);"leftHandle"===l.attr("class")?n(t,e,l):o(t,e,l)}).on("end",(t,e)=>{s.isDragging=!1,e._end===e.end&&(e._trimRight=null),e._start===e.start&&(e._trimLeft=null),d3.select(`#locus_${e.uid} .hover`).transition().attr("opacity",0),c.update()})(t)},dragPosition(t){let e,l,a,o,d;return d3.drag().on("start",(t,n)=>{[e,l]=p.extent([n.uid]),a=t.x,o=u.locus(n.uid),s.isDragging=!0}).on("drag",(t,n)=>{o+=t.x-a,(d=i.locus(n.uid)).attr("transform",`translate(${o}, 0)`),d3.selectAll("g.geneLinkG").call(g.update,!1);let s=d.datum(),c=u.x(s._start);if(r.cluster.alignLabels){let p=Math.min(o+u.offset(n._cluster)+c,e)-10;d3.selectAll("g.clusterInfo").attr("transform",t=>`translate(${p-u.offset(t.uid)}, 0)`)}else d3.select(`#cinfo_${n._cluster}`).attr("transform",`translate(${o+c-10}, 0)`);let f=u.x(s._end),h=Math.max(o+u.offset(n._cluster)+f,l)+20;d3.select("g.legend").attr("transform",`translate(${h}, 0)`)}).on("end",(t,e)=>{s.isDragging=!1,n("locus",e.uid,o),c.update()})(t)},flip(t){t._flipped=!t._flipped;let e=t.end-t.start,l=t._trimRight;t._trimRight=t._trimLeft,t._trimLeft=l,t.genes.forEach(t=>{let l=t._start;t._start=e-t._end,t._end=e-l,t._strand=1===t._strand?-1:1}),t.genes.sort((t,e)=>t._start-e._start)}},h={check:t=>h.checkDomain(t)&&h.checkRange(t),checkDomain:t=>u[t].domain().length>0,checkRange:t=>u[t].range().length>0,updateX(){u.x.range([0,r.plot.scaleFactor])},updateY(t){let e=2*r.gene.shape.tipHeight+r.gene.shape.bodyHeight,l=t.clusters.map((t,l)=>l*(r.cluster.spacing+e));u.y.range(l)},updateOffset(t){u.offset.domain(t.map(t=>t.uid)).range(t.map(()=>0))},updateLocus(t){let[e,l]=p.getLocusScaleValues(t);u.locus.domain(e).range(l)},rescaleRanges(t){[u.offset,u.locus].forEach(e=>{let l=e.range();for(let a=0;a<l.length;a++){let n=t.invert(l[a]);l[a]=u.x(n)}e.range(l)})},update(t){let e=u.x.copy();h.updateX(),h.rescaleRanges(e),h.check("y")||u.y.domain(t.clusters.map(t=>t.uid)),h.updateY(t),h.check("offset")||h.updateOffset(t.clusters),h.check("locus")||h.updateLocus(t.clusters)}},y=t=>{d3.select(t.target).transition().duration(0).style("opacity",1).style("pointer-events","all"),d3.select(window).on("click",e=>{e.target===t.target||t.target.contains(e.target)||d3.select(t.target).transition().style("opacity",0).style("pointer-events","none")})},m=t=>{let e=d3.select(t.target),l=document.activeElement;"INPUT"===l.tagName&&e.node().contains(l)||e.transition().delay(400).style("opacity",0).style("pointer-events","none")},x={tooltipHTML(t){let e=d3.create("div").attr("class","tooltip-contents").style("display","flex").style("flex-direction","column");e.append("text").text("Edit label");let l=e.append("input").attr("type","input").attr("value",t.label||t.uid);e.append("text").text("Merge with...");let a=c.data().groups,n=e.append("select").attr("multiple",!0);return n.selectAll("option").data(a.filter(e=>e.uid!==t.uid)).join("option").text(t=>t.label).attr("value",t=>t.uid),e.append("button").text("Merge!").on("click",()=>{let e=[];for(let l of n.node().options)l.selected&&e.push(l);let r=[];for(let s of e){let o=a.findIndex(t=>t.uid===s.value);r.push(o),t.genes.push(...a[o].genes),s.remove()}for(let i of(r.sort((t,e)=>e-t),r))a.splice(i,1);c.data({...c.data(),groups:a}),c.update()}),e.append("label").append("text").text("Choose group colour: ").append("input").attr("type","color").attr("default",t.colour).on("change",e=>{t.colour=e.target.value,c.update()}),e.append("button").text("Hide group").on("click",()=>{t.hidden=!0,c.update()}),l.on("input",e=>{t.label=e.target.value,n.attr("value",null),c.update({})}),e},contextMenu(t,e){t.preventDefault();let l=d3.select("div.tooltip");l.html(""),l.append(()=>x.tooltipHTML(e).node());let a=t.target.getBoundingClientRect(),n=l.node().getBoundingClientRect(),r=a.width/2-n.width/2,s=1.2*a.height;l.style("left",a.x+r+"px").style("top",a.y+s+"px"),l.transition().duration(100).style("opacity",1).style("pointer-events","all"),l.transition().delay(1e3).style("opacity",0).style("pointer-events","none")}};r.gene.shape.onClick=d.anchor,r.legend.onClickText=g.rename,r.legend.onAltClickText=x.contextMenu,t.ClusterMap=function(){let t=null,l=d3.transition();function a(t){t.each(n)}function n(a){t=d3.select(this).attr("width","100%").attr("height","100%"),l=d3.transition().duration(r.plot.transitionDuration);let n=t.selectAll("svg.clusterMap").data([a]).join(t=>{t.append("input").attr("id","picker").attr("class","colourPicker").attr("type","color").style("position","absolute").style("opacity",0),t.append("div").attr("class","tooltip").style("opacity",0).style("position","absolute").style("pointer-events","none").on("mouseenter",y).on("mouseleave",m);let e=t.append("svg").attr("class","clusterMap").attr("id","root-svg").attr("cursor","grab").attr("width","100%").attr("height","100%").attr("xmlns","http://www.w3.org/2000/svg").attr("xmlns:xhtml","http://www.w3.org/1999/xhtml"),l=e.append("defs").append("filter").attr("id","filter_solid").attr("x",0).attr("y",0).attr("width",1).attr("height",1);l.append("feFlood").attr("flood-color","rgba(0, 0, 0, 0.8)"),l.append("feComposite").attr("in","SourceGraphic").attr("in2","");let a=e.append("g").attr("class","clusterMapG"),n=d3.zoom().scaleExtent([0,8]).on("zoom",t=>a.attr("transform",t.transform)).on("start",()=>e.attr("cursor","grabbing")).on("end",()=>e.attr("cursor","grab")),r=d3.zoomIdentity.translate(20,50).scale(1.2);return e.call(n).call(n.transform,r).on("dblclick.zoom",null),a},t=>t.call(t=>{t.call(o)}));h.update(a),a.config&&!1===a.config.updateGroups?a.groups||(a.groups=[]):a.groups=g.getGroups(a.links,a.groups),g.updateGroups(a.groups),t=d3.select(this);let b=n.selectAll("g.links").data([a]).join("g").attr("class","links");n.selectAll("g.clusters").data([a.clusters]).join("g").attr("class","clusters").selectAll("g.cluster").data(a.clusters,t=>t.uid).join(t=>{let l=(t=t.append("g").attr("id",p.getId).attr("class","cluster").each(i)).append("g").attr("id",t=>`cinfo_${t.uid}`).attr("class","clusterInfo").attr("transform","translate(-10, 0)").call(p.drag);return l.append("text").text(t=>t.name).attr("class","clusterText").attr("y",8).attr("cursor","pointer").style("font-weight","bold").style("font-family",r.plot.fontFamily).on("click",e),l.append("text").attr("class","locusText").attr("y",12).style("dominant-baseline","hanging").style("font-family",r.plot.fontFamily),t.append("g").attr("class","loci"),l.selectAll("text").attr("text-anchor","end").style("font-family",r.plot.fontFamily),t.call(p.update)},t=>t.call(t=>t.transition(l).call(p.update))).selectAll("g.loci").selectAll("g.locus").data(t=>t.loci,t=>t.uid).join(t=>{for(let e of t.data())if(0!==e.start)for(let l of(e._bio_start=e.start,e._bio_end=e.end,e.start=0,e.end=e._bio_end-e._bio_start,e.genes))l._start=l.start-e._bio_start,l._end=l.end-e._bio_start;(t=t.append("g").attr("id",f.getId).attr("class","locus")).append("line").attr("class","trackBar").style("fill","#111");let a=t.append("g").attr("class","hover hidden").attr("opacity",0);return t.append("g").attr("class","genes"),a.append("rect").attr("class","hover").attr("fill","rgba(0, 0, 0, 0.4)").call(f.dragPosition),a.append("rect").attr("class","leftHandle").attr("x",-8).call(f.dragResize),a.append("rect").attr("class","rightHandle").call(f.dragResize),a.selectAll(".leftHandle, .rightHandle").attr("width",8).attr("cursor","pointer"),t.on("mouseenter",t=>{s.isDragging||d3.select(t.target).select("g.hover").transition().attr("opacity",1)}).on("mouseleave",t=>{s.isDragging||d3.select(t.target).select("g.hover").transition().attr("opacity",0)}).on("dblclick",(t,e)=>{f.flip(e),c.update()}),t.call(f.update)},t=>t.call(t=>t.transition(l).call(f.update))).selectAll("g.genes").selectAll("g.gene").data(t=>t.genes,t=>t.uid).join(t=>((t=t.append("g").attr("id",d.getId).attr("class","gene").attr("display","inline")).append("polygon").on("click",r.gene.shape.onClick).on("contextmenu",d.contextMenu).attr("class","genePolygon"),t.append("text").attr("class","geneLabel").attr("dy","-0.3em").style("font-family",r.plot.fontFamily),t.call(d.update)),t=>t.call(t=>t.transition(l).call(d.update))),b.selectAll("g.geneLinkG").data(g.filter(a.links),g.getId).join(t=>((t=t.append("g").attr("id",g.getId).attr("class","geneLinkG")).append("path").attr("class","geneLink"),t.append("text").text(t=>t.identity.toFixed(2)).attr("class","geneLinkLabel").style("fill","white").style("text-anchor","middle").style("font-family",r.plot.fontFamily),t.call(g.update)),t=>t.call(t=>t.classed("hidden",!r.link.show).transition(l).call(g.update,!0)),t=>t.call(t=>{t.transition(l).attr("opacity",0).remove()}));let _,k,v,w=(v=((k=d3.selectAll("g.gene")).empty()?_=[]:(_=u.colour.domain(),k.each((t,e,l)=>{let a=d3.select(l[e]).attr("display"),n=u.group(t.uid);"inline"===a&&null!==n&&_.includes(n)&&(_=_.filter(t=>t!==n))})),_),(function(t){let e=15,l=12,a=[],n=()=>{},s=()=>{},o=()=>{},i=d3.scaleBand().paddingInner(.5),c=d3.transition().duration(500);function u(t){t.each(function(t){let l=t.groups.filter(t=>!a.includes(t.uid)&&!t.hidden);i.domain(l.map(t=>t.uid)).range([0,e*l.length]);let u=d3.select(this).selectAll("g.legend").data([t]).join("g").attr("class","legend"),p=t=>`translate(0, ${i(t.uid)})`;u.selectAll("g.element").data(l,t=>t.uid).join(t=>((t=t.append("g").attr("class","element").attr("transform",p)).append("circle").attr("class",t=>`group-${t.uid}`),t.append("text").attr("x",16).attr("text-anchor","start").style("font-family",r.plot.fontFamily).style("dominant-baseline","middle"),t.call(d)),t=>t.call(t=>t.transition(c).attr("transform",p).call(d))),n&&u.selectAll("circle").attr("cursor","pointer").on("click",n),u.selectAll("text").attr("cursor","pointer").on("click",s).on("contextmenu",o)})}function d(e){e.attr("transform",t=>`translate(0, ${i(t.uid)})`);let a=i.bandwidth()/2;e.selectAll("text").text(t=>t.label).attr("x",a+6).attr("y",a+1).style("font-size",`${l}px`),e.selectAll("circle").attr("cy",a).attr("r",a).attr("fill",e=>t(e.uid))}return u.colourScale=e=>arguments.length?(t=e,u):t,u.transition=t=>arguments.length?(c=t,u):c,u.hidden=t=>arguments.length?(a=t,u):a,u.entryHeight=t=>arguments.length?(e=parseInt(t),u):e,u.fontSize=t=>arguments.length?(l=parseInt(t),u):l,u.onClickCircle=t=>arguments.length?(n=t,u):n,u.onClickText=t=>arguments.length?(s=t,u):s,u.onAltClickText=t=>arguments.length?(o=t,u):o,u})(u.colour).hidden(v).fontSize(r.legend.fontSize).entryHeight(r.legend.entryHeight).onClickCircle(r.legend.onClickCircle||x).onClickText(r.legend.onClickText).onAltClickText(r.legend.onAltClickText)),L=(function(t){let e=1e3,l=1,a=10,n="black",s=12,o=d3.transition().duration(500),i=null;function c(t){t.each(function(t){d3.select(this).selectAll("g.scaleBar").data([t]).join(t=>((t=t.append("g").attr("class","scaleBar")).append("line").attr("class","flatBar"),t.append("line").attr("class","leftBar"),t.append("line").attr("class","rightBar"),t.append("text").attr("class","barText").attr("text-anchor","middle").attr("cursor","pointer").style("font-family",r.plot.fontFamily).on("click",i||p),t.call(d),t),t=>t.call(t=>t.transition(o).call(d)))})}function u(){return+(e/1e3).toFixed(1)+"kb"}function d(r){let o=a/2,i=t(e);r.select(".flatBar").attr("x2",i).attr("y1",o).attr("y2",o),r.select(".leftBar").attr("y2",a),r.select(".rightBar").attr("x1",i).attr("x2",i).attr("y2",a),r.select("text.barText").text(u).attr("x",i/2).attr("y",a+5).style("dominant-baseline","hanging").style("font-size",`${s}pt`),r.selectAll("line").style("stroke",n).style("stroke-width",l)}function p(){let t=prompt("Enter new length (bp):",e);t&&c.basePair(t)}return c.basePair=t=>arguments.length?(e=parseInt(t),c):e,c.colour=t=>arguments.length?(n=t,c):n,c.colourScale=t=>arguments.length?(colourScale=t,c):colourScale,c.fontSize=t=>arguments.length?(s=parseInt(t),c):s,c.height=t=>arguments.length?(a=parseInt(t),c):a,c.onClickText=t=>arguments.length?(i=t,c):i,c.stroke=t=>arguments.length?(l=parseInt(t),c):l,c.transition=t=>arguments.length?(o=t,c):o,c.width=t=>arguments.length?(width=parseInt(t),c):width,c})(u.x).stroke(r.scaleBar.stroke).height(r.scaleBar.height).colour(r.scaleBar.colour).basePair(r.scaleBar.basePair).fontSize(r.scaleBar.fontSize).onClickText($).transition(l),T=(function(t){let e=25,l=150,a=12,n=d3.transition();function s(t){t.each(function(t){d3.select(this).selectAll("g.colourBar").data([t]).join(t=>{let e=(t=t.append("g").attr("class","colourBar")).append("defs").append("linearGradient").attr("id","cbarGradient").attr("x1","0%").attr("x2","100%");e.append("stop").attr("class","startStop").attr("offset","0%"),e.append("stop").attr("class","endStop").attr("offset","100%");let l=t.append("g").attr("class","cbarParts");return l.append("rect").attr("class","colourBarBG").style("fill","white").style("stroke","black").style("stroke-width","1px"),l.append("rect").attr("class","colourBarFill").style("fill","url(#cbarGradient)"),l.append("text").text("Identity (%)").attr("class","labelText").attr("text-anchor","middle"),l.append("text").text("0").attr("class","startText").attr("text-anchor","start"),l.append("text").text("100").attr("class","endText").attr("text-anchor","end"),l.selectAll("text").style("font-family",r.plot.fontFamily).style("dominant-baseline","hanging"),t.call(o),t},t=>t.call(t=>t.transition(n).call(o)))})}function o(n){n.select(".startStop").attr("stop-color",t(0)),n.select(".endStop").attr("stop-color",t(1)),n.selectAll("rect").attr("width",l).attr("height",e),n.selectAll(".startText, .endText, .labelText").attr("y",e+5),n.select(".labelText").attr("x",l/2),n.select(".endText").attr("x",l),n.selectAll("text").style("font-size",`${a}pt`)}return s.width=t=>arguments.length?(l=parseInt(t),s):l,s.height=t=>arguments.length?(e=parseInt(t),s):e,s.fontSize=t=>arguments.length?(a=parseInt(t),s):a,s.colourScale=e=>arguments.length?(t=e,s):t,s.transition=t=>arguments.length?(n=t,s):n,s})(u.score).width(r.colourBar.width).height(r.colourBar.height).fontSize(r.colourBar.fontSize).transition(l);n.call(w).call(T).call(L).call(o)}function o(t){let e=r.plot.scaleGenes;t.select("g.scaleBar").classed("hidden",!e).transition(l).attr("opacity",e?1:0).attr("transform",c.scaleBarTransform);let a=r.link.groupColour||!r.link.show;t.select("g.colourBar").classed("hidden",!!a).transition(l).attr("opacity",a?0:1).attr("transform",c.colourBarTransform),t.select("g.legend").transition(l).attr("transform",c.legendTransform)}function i(t){t.loci.forEach(e=>{e._start=e._start||e.start,e._end=e._end||e.end,e._offset=e._offset||0,e._cluster=e._cluster||t.uid,e._flipped=e._flipped||!1,e._trimLeft=e._trimLeft||null,e._trimRight=e._trimRight||null,e.genes.forEach(l=>{l._locus=l._locus||e.uid,l._cluster=l._cluster||t.uid,l._start=l._start||l.start,l._end=l._end||l.end,l._strand=l._strand||l.strand})})}function x(t,e){let l=d3.select("input.colourPicker");l.on("change",()=>{e.colour=l.node().value,c.update()}),l.node().click()}function $(){let t=prompt("Enter new length (bp):",r.scaleBar.basePair);t&&(r.scaleBar.basePair=t,c.update())}return c.update=()=>t.call(a),c.data=t=>a.data(t),a.config=function(t){return arguments.length?(c.updateConfig(t),a):r},a.data=e=>e?(t.datum(e).call(a),a):t.select("svg.clusterMap").datum(),a},Object.defineProperty(t,"__esModule",{value:!0})});