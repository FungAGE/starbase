{% extends "base.html" %}

{% block content %}
<div class="container">
    <h2 class="text-center">BLAST Search</h2>
    
    <!-- Original BLAST input form -->
    <div id="blast-form">
        <form id="blast-search-form" method="POST">
            <!-- Your existing BLAST input fields -->
        </form>
    </div>

    <!-- Results section (initially hidden) -->
    <div id="blast-results" style="display: none;">
        <input type="file" id="blastinput" style="display: none;" />
        <div id="blast-multiple-alignments"></div>
        <div id="blast-alignments-table"></div>
        <div id="blast-single-alignment"></div>
    </div>
</div>

<!-- Add required scripts -->
{% block scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/html2canvas.js') }}"></script>
<script src="{{ url_for('static', filename='js/blaster.min.js') }}"></script>
<script>
document.getElementById('blast-search-form').onsubmit = function(e) {
    e.preventDefault();
    
    // Update the URL to point to our new API endpoint
    fetch('/blast-api', {
        method: 'POST',
        body: new FormData(this)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.text();
    })
    .then(data => {
        try {
            // Check if the response is an error message
            const jsonData = JSON.parse(data);
            if (jsonData.error) {
                throw new Error(jsonData.error);
            }
            
            // Hide the form and show results
            document.getElementById('blast-form').style.display = 'none';
            document.getElementById('blast-results').style.display = 'block';
            
            // Initialize blasterjs with the BLAST results
            var blasterjs = require("biojs-vis-blasterjs");
            var instance = new blasterjs({
                input: "blastinput",
                multipleAlignments: "blast-multiple-alignments",
                alignmentsTable: "blast-alignments-table",
                singleAlignment: "blast-single-alignment",
                string: data
            });
        } catch (e) {
            alert('Error: ' + e.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error: ' + error.message);
    });
    
    return false;
};
</script>
{% endblock %}
{% endblock %} 